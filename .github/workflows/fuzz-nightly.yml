# .github/workflows/fuzz-nightly.yml
name: Fuzz (nightly – long running)

on:
  schedule:
    - cron: "0 10 * * *" # 10:00 UTC daily
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 400   # ~6.5 h total safety margin
    strategy:
      fail-fast: false
      matrix:
        target: [clone, expose, mut, parsing, serde, zeroizing]
        mode: [normal, asan]   # normal = no sanitizer, asan = Address + Leak

    env:
      # libFuzzer flags that work well on GitHub runners
      FUZZER_ARGS: >-
        -fork=1
        -timeout=60
        -rss_limit_mb=8192
        -runs=0
        -max_total_time=3500   # ~58 min real fuzzing time (leaves margin)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust nightly + rust-src
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
          components: rust-src

      - name: Cache cargo & target dir
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Download previous corpora
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: fuzz-corpus-*
          path: fuzz/corpus/
          merge-multiple: true

      - name: Seed minimal corpus (prevents instant exit)
        run: |
          mkdir -p fuzz/corpus/{clone,expose,mut,parsing,serde,zeroizing}
          for dir in fuzz/corpus/*; do
            if [ -z "$(ls -A "$dir" 2>/dev/null)" ]; then
              echo "Seeding initial inputs for $(basename "$dir")"
              printf 'fuzzme'          > "$dir/seed_basic"
              printf '\\x00\\x00\\x00\\x00' > "$dir/seed_zero"
              printf '\\xff\\xff\\xff\\xff' > "$dir/seed_ff"
              printf 'A%.0s' {1..2000}  > "$dir/seed_long"
              head -c 500 /dev/urandom  > "$dir/seed_random"
            fi
          done

      - name: Fuzz – ${{ matrix.target }} (${{ matrix.mode }})
        env:
          RUSTFLAGS: ${{ matrix.mode == 'asan' && '-Zsanitizer=address -Zsanitizer=leak -Cdebuginfo=2' || '' }}
          ASAN_OPTIONS: detect_leaks=1 abort_on_error=1 symbolize=1 allocator_may_return_null=1
        run: |
          echo "Starting 58-minute fuzz run for ${{ matrix.target }} (${{ matrix.mode }})"
          cargo +nightly fuzz run ${{ matrix.target }} $FUZZER_ARGS

      - name: Upload grown corpus
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-corpus-${{ matrix.target }}-${{ matrix.mode }}-${{ github.run_id }}
          path: fuzz/corpus/${{ matrix.target }}/
          retention-days: 60
          if-no-files-found: error

      - name: Upload crash artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-crash-${{ matrix.target }}-${{ matrix.mode }}-${{ github.run_id }}
          path: fuzz/artifacts/${{ matrix.target }}/**
          retention-days: 30
          if-no-files-found: warn

  coverage:
    name: Fuzz Coverage Report
    runs-on: ubuntu-latest
    needs: fuzz
    if: success() || failure()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
          components: rust-src

      - name: Install llvm-tools (required for llvm-cov)
        run: rustup component add llvm-tools-preview

      - name: Add LLVM tools to PATH
        run: echo "$(rustc --print sysroot)/lib/rustlib/x86_64-unknown-linux-gnu/bin" >> $GITHUB_PATH

      - name: Cache
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Download all fresh corpora
        uses: actions/download-artifact@v4
        with:
          pattern: fuzz-corpus-*
          path: fuzz/corpus/
          merge-multiple: false   # IMPORTANT: False to preserve per-target dirs

      - name: Generate HTML + lcov coverage
        run: |
          mkdir -p coverage/html coverage/lcov
          for target in clone expose mut parsing serde zeroizing; do
            # Find the normal-mode corpus dir (e.g., fuzz-corpus-clone-normal-*)
            corpus_dir=$(find fuzz/corpus -type d -name "fuzz-corpus-$target-normal-*" -print -quit)
            echo "Corpus dir for $target: $corpus_dir"

            if [ -z "$corpus_dir" ] || [ -z "$(ls -A "$corpus_dir")" ]; then
              echo "No corpus for $target, skipping coverage"
              continue
            fi

            echo "=== Generating coverage for $target ==="
            cargo +nightly fuzz coverage $target "$corpus_dir" -- -runs=200000

            llvm-cov show \
              --instr-profile=fuzz/coverage/$target/coverage.profdata \
              --format=html \
              --ignore-filename-regex='/.cargo|/rustc/' \
              --output-dir=coverage/html/$target

            echo "Generated HTML files:"
            ls -R coverage/html/$target || echo "No HTML files generated (check llvm-cov errors above)"

            cargo +nightly fuzz coverage $target "$corpus_dir" --lcov --output-path=coverage/lcov/$target.info
          done

      - name: Upload HTML coverage
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-coverage-html-${{ github.run_id }}
          path: coverage/html/
          retention-days: 90
          if-no-files-found: warn   # OK if empty in early runs
